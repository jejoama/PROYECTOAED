---
title: Evolución de la actividad, ocupación para grupos de edad mayores de 16 años
author:
  - name: Dominik Leutnant
    affil: 1,2,\ddagger,*
    orcid: 0000-0003-3293-2315
  - name: John Doe
    affil: 2, \dagger, \ddagger
affiliation:
  - num: 1
    address: |
      Muenster University of Applied Sciences - 
      Institute for Infrastructure, Water, Resources, Environment
      Correnstr. 25, 48149 Muenster, Germany
    email: leutnant@fh-muenster.de
  - num: 2
    address: |
      Your department
      Street, City, Country
    email: mail@mail.com
# author citation list in chicago format
authorcitation: |
  Leutnant, D.; Doe, J.
# firstnote to eighthnote
firstnote: |
  Current address: Updated affiliation
secondnote: |
  These authors contributed equally to this work.
correspondence: |
  leutnant@fh-muenster.de; Tel.: +XX-000-00-0000.
# document options
journal: notspecified
type: article
status: submit
# front matter
simplesummary: |
  A Simple summary goes here.
abstract: |

keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).
# back matter

bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

# Version



## Journal Specific YAML variables




```{r}
rm(list=ls())
```

# Carga de Librerías

```{r}
# Aquí habría que hacer algún scrip para descargar las librerías si no las tienen
library(readr)
library(dplyr)
library(tidyr)
library(forcats)
library(ggplot2)
library(gganimate)
library(gifski)
library(stringr)
```



# Significado de los Datos del Mercado Laboral (EPA)

## Relaciones Fundamentales


El valor de la columna **Total** viene definido con la siguiente expresión:

$$\text{Total}=\text{Activos}+\text{Inactivos}$$
Y los **Activos** se dividen en Ocupados y Parados:

$$\text{Activos}=\text{Ocupados}+\text{Parados}$$
## Fórmulas para el análisis (Tasas)

Las tasas permiten normalizar los datos y son la base para el análisis de brechas y series temporales:



La **tasa de paro** mide la proporción de la población activa que está desempleada:

$$\text{Tasa de paro}=\frac{\text{Parados}}{\text{Activos}} \cdot 100$$

La **tasa de actividad** mide la participación de una población en el mercado laboral:

$$\text{Tasa de actividad}=\frac{\text{Activos}}{\text{Total}} \cdot 100$$
La **tasa de ocupación** muestra qué parte de la población total de referencia tiene un empleo:

$$\text{Tasa de ocupación}=\frac{\text{Ocupados}}{\text{Total}} \cdot 100$$



# Proceso de limpieza y transformación de los datos


## Importación y verificación inicial

- **Codificación e importación**: Se verifica la codificación y se importa el archivo CSV delimitado por tabulaciones, se indica que el separador decimal es la coma y que los valores *NA* están representados por `r".."`


```{r}
# Ver el tipo de codificación del archivo
archivo<-"data/65948.csv"
guess_encoding(archivo)
```


```{r}
df<-read_delim(archivo, delim = "\t", escape_double = FALSE, na = "..", trim_ws = TRUE,locale = locale(decimal_mark = ","))
```

- Se comprueba la estructura inicial:

```{r}
str(df)
```

- Se comprueba las columnas que tienen valores *NA*

```{r}
sapply(df,function(x) sum(is.na(x)))
```

## Limpieza y filtrado

- Se guarda en un dataframe `df_na` las instancias con *NA*

```{r}
# Guardar los valores NA por si los necesitamos
df_na<-df[which(is.na(df$Total)),]
```

Se transforma el dataframe a formato tidy, se elimina la información redundante que causa errores matemáticos y estadísticos.

- **Renombrar columnas**: Utilizando `rename()` para acortar `"Relación con la actividad económica"` por ` "Situacion_Laboral"` para simplificar el manejo de columnas.

- **Filtrado de doble conteo**: Se eliminan las instancias donde las variables representan la suma de otras instancias (`Sexo="Ambos sexos"` y `Edad="Total"`)

- **Se aplica `pivot_wider()`** utilizando los valores de la columna `Situacion_Laboral` para crear las nuevas columnas (`names_from`) y los valores numéricos de la columna `Total`. De esta forma se cumple la regla tidy de una variable por columna.

- **Renombrar variables**: Se renombra la columna `"parados que buscan primer empleo"` a un formato más corto `r "Parados_sin_exp"`

- **Imputación de NA a 0**: Los valores faltantes se concentran en categorías como Personas mayores de 65 en paro o que buscan su primer empleo. El INE suprime el dato por ser un valor insignificante, por lo que se opta por remplazar los valores nulos a 0 para no perder el resto de información válida de la instancia.

- **Creación de tasas**: Se añaden las columnas `Tasa_paro`, `Tasa_actividad` y `Tasa_ocupacion` utilizando `mutate()` y las expresiones de la EPA.

- **Ordenación en factores**: Se ordena la columna `Edad` como un factor ordinal y la columna `Sexo` como factor nominal.

```{r}
df_ancho<-df %>% 
  rename(Situacion_Laboral = "Relación con la actividad económica") %>% 
  filter(Sexo != "Ambos sexos", Edad != "Total") %>% 
  mutate(Sexo=as.factor(Sexo), Edad=as.factor(Edad),Situacion_Laboral=as.factor(Situacion_Laboral)) %>%
  pivot_wider(names_from = Situacion_Laboral,values_from = Total) %>% 
  rename(Parados_sin_exp="Parados que buscan primer empleo") %>% 
  mutate(across(.cols=c(Parados,Parados_sin_exp,Activos,Ocupados,Inactivos),.fns=~replace_na(.,0))) %>% 
  mutate(across(c(Activos, Ocupados, Parados, Inactivos, Total), as.numeric),Tasa_paro=Parados/Activos*100,Tasa_actividad=Activos/Total*100,Tasa_ocupacion=Ocupados/Total*100)
```


```{r}
df_ancho <- df_ancho %>%
  mutate(
    Edad = str_replace(Edad, "De ", ""),
    Edad = str_replace(Edad, " a ", "-"),
    Edad = str_replace(Edad, " años", ""),
    Edad = str_replace(Edad, "70 y más", "70+"),
    
    Edad = factor(Edad, levels = c(
      "16-19", "20-24", "25-29", "30-34", "35-39", 
      "40-44", "45-49", "50-54", "55-59", "60-64", 
      "65-69", "70+"), ordered = T
      )
  )

```


Guardar el dataframe limpio:

```{r}
write_csv(df_ancho,file = "data/df_clean.csv")
```




```{r}
# animacion_actividad <- df_ancho %>%
#   ggplot(aes(x = Edad, y = Tasa_actividad, color = Sexo, group = Edad)) +
#   geom_point(size = 4, alpha = 0.8) +
#   geom_line(aes(group = Edad), alpha = 0.5) +
#   labs(
#     title = "Tasa de Actividad por Edad y Sexo - Año: {as.integer(frame_time)}",
#     subtitle = "La brecha de género en la participación laboral.",
#     y = "Tasa de Actividad (%)",
#     x= "Edad (años)"
#   ) +
#   theme_minimal() +
#   transition_time(Periodo) +
#   ease_aes('linear')
# anim_save(
#   filename = "evolucion_actividad.gif", 
#   animation = animacion_actividad,
#   renderer = gifski_renderer(loop = TRUE)
# )
```


## Vista general de la limpieza 



```{r}
str(df_ancho)
```

Comprobar que no haya valores nulos:

```{r}
sapply(df_ancho,function(x) sum(is.na(x)))
```

Valores estadísticos:

```{r}
summary(df_ancho)
```

```{r}
edades_focales <- c(
  "25-29",
  "30-34",
  "35-39",
  "40-44",
  "45-49",
  "50-54"
)
t.test(Tasa_ocupacion ~ Sexo, data = df_ancho%>% filter(Periodo == 2024,Edad%in%edades_focales))
```



