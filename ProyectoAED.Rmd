---
title: "ProyectoAED"
# author: "Javier Herrero Pérez"
date: "2025-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
rm(list=ls())
```

# Carga de Librerías

```{r}
# Aquí habría que hacer algún scrip para descargar las librerías si no las tienen
library(readr)
library(dplyr)
library(tidyr)
library(forcats)
```



# Significado de los Datos del Mercado Laboral (EPA)

## Relaciones Fundamentales


El valor de la columna **Total** viene definido con la siguiente expresión:

$$\text{Total}=\text{Activos}+\text{Inactivos}$$
Y los **Activos** se dividen en Ocupados y Parados:

$$\text{Activos}=\text{Ocupados}+\text{Parados}$$
## Fórmulas para el análisis (Tasas)

Las tasas permiten normalizar los datos y son la base para el análisis de brechas y series temporales:



La **tasa de paro** mide la proporción de la población activa que está desempleada:

$$\text{Tasa de paro}=\frac{\text{Parados}}{\text{Activos}} \cdot 100$$

La **tasa de actividad** mide la participación de una población en el mercado laboral:

$$\text{Tasa de actividad}=\frac{\text{Activos}}{\text{Total}} \cdot 100$$
La **tasa de ocupación** muestra qué parte de la población total de referencia tiene un empleo:

$$\text{Tasa de ocupación}=\frac{\text{Ocupados}}{\text{Total}} \cdot 100$$



# Proceso de limpieza y transformación de los datos


## Importación y verificación inicial

- **Codificación e importación**: Se verifica la codificación y se importa el archivo CSV delimitado por tabulaciones, se indica que el separador decimal es la coma y que los valores *NA* están representados por `r".."`


```{r}
# Ver el tipo de codificación del archivo
archivo<-"data/65948.csv"
guess_encoding(archivo)
```


```{r}
df<-read_delim(archivo, delim = "\t", escape_double = FALSE, na = "..", trim_ws = TRUE,locale = locale(decimal_mark = ","))
```

- Se comprueba la estructura inicial:

```{r}
str(df)
```

- Se comprueba las columnas que tienen valores *NA*

```{r}
sapply(df,function(x) sum(is.na(x)))
```

## Limpieza y filtrado

- Se guarda en un dataframe `df_na` las instancias con *NA*

```{r}
# Guardar los valores NA por si los necesitamos
df_na<-df[which(is.na(df$Total)),]
```

Se transforma el dataframe a formato tidy, se elimina la información redundante que causa errores matemáticos y estadísticos.

- **Renombrar columnas**: Utilizando `rename()` para acortar `"Relación con la actividad económica"` por ` "Situacion_Laboral"` para simplificar el manejo de columnas.

- **Filtrado de doble conteo**: Se eliminan las instancias donde las variables representan la suma de otras instancias (`Sexo="Ambos sexos"` y `Edad="Total"`)

- **Se aplica `pivot_wider()`** utilizando los valores de la columna `Situacion_Laboral` para crear las nuevas columnas (`names_from`) y los valores numéricos de la columna `Total`. De esta forma se cumple la regla tidy de una variable por columna.

- **Renombrar variables**: Se renombra la columna `"parados que buscan primer empleo"` a un formato más corto `r "Parados_sin_exp"`

- **Imputación de NA a 0**: Los valores faltantes se concentran en categorías como Personas mayores de 65 en paro o que buscan su primer empleo. El INE suprime el dato por ser un valor insignificante, por lo que se opta por remplazar los valores nulos a 0 para no perder el resto de información válida de la instancia.

- **Creación de tasas**: Se añaden las columnas `Tasa_paro`, `Tasa_actividad` y `Tasa_ocupacion` utilizando `mutate()` y las expresiones de la EPA.

- **Ordenación en factores**: Se ordena la columna `Edad` como un factor ordinal y la columna `Sexo` como factor nominal.

```{r}
orden_edad<-c("De 16 a 19 años","De 20 a 24 años","De 25 a 29 años","De 30 a 34 años","De 35 a 39 años","De 40 a 44 años","De 45 a 49 años","De 50 a 54 años","De 55 a 59 años","De 60 a 64 años","De 65 a 69 años","70 y más años")

df_ancho<-df %>% 
  rename(Situacion_Laboral = "Relación con la actividad económica") %>% 
  filter(Sexo != "Ambos sexos", Edad != "Total") %>% 
  mutate(Sexo=as.factor(Sexo), Edad=as.factor(Edad),Situacion_Laboral=as.factor(Situacion_Laboral)) %>%
  pivot_wider(names_from = Situacion_Laboral,values_from = Total) %>% 
  rename(Parados_sin_exp="Parados que buscan primer empleo") %>% 
  mutate(across(.cols=c(Parados,Parados_sin_exp,Activos,Ocupados,Inactivos),.fns=~replace_na(.,0))) %>% 
  mutate(across(c(Activos, Ocupados, Parados, Inactivos, Total), as.numeric),Tasa_paro=Parados/Activos*100,Tasa_actividad=Activos/Total*100,Tasa_ocupacion=Ocupados/Total*100) %>% 
  mutate(Edad=fct_relevel(Edad,orden_edad))

```


Guardar el dataframe limpio:

```{r}
write_csv(df_ancho,file = "data/df_clean.csv")
```



## Vista general de la limpieza 


```{r}
str(df_ancho)
```

Comprobar que no haya valores nulos:

```{r}
sapply(df_ancho,function(x) sum(is.na(x)))
```

Valores estadísticos:

```{r}
summary(df_ancho)
```




