---
title: "Comparación brecha Proyecto"
output: html_document
date: "2025-10-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Gráficos Brecha
Importamos el dataframe para trabajar con el: 
```{r}
datos<-read.csv("data/df_clean.csv")
```

Tenemos el dataframe, listo para trabajar cargado en la variable datos.

##Evolucion de la tasa de paro por género y evolución de la brecha de la tasa de paro por género


En este bloque de código se construyen varias representaciones gráficas con el fin de analizar la evolución de la tasa de paro y la brecha de género a lo largo del tiempo. Para ello, se parte de una tabla en la que se calcula la variable *brecha_paro*, definida como la diferencia entre la tasa de paro de mujeres y la de hombres. Posteriormente, los datos se agrupan por periodo para obtener las tasas medias anuales de paro por sexo y la brecha media correspondiente. 


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# 1º crear una tabla con la variable brecha_paro 
brecha <- datos %>% 
  select(Periodo, Edad,Sexo,Tasa_paro) %>% 
  pivot_wider(names_from = Sexo, values_from = Tasa_paro) %>% 
  mutate(brecha_paro=Mujeres-Hombres)
brecha

#2º Agrupar esas fechas por periodo, para asi no diferenciar entre grupos de edades y tener la brecha total
brechas_total <- brecha %>%
  group_by(Periodo) %>%
  summarise(
    tasa_hombres = mean(Hombres, na.rm = TRUE),
    tasa_mujeres = mean(Mujeres, na.rm = TRUE),
    brecha_paro_total = mean(brecha_paro, na.rm = TRUE)
  )
brechas_total

evo_brecha_total <- ggplot(brechas_total,aes(x=Periodo,y=brecha_paro_total)) + geom_line()+geom_point()+labs(title = "Evolución de la brecha de paro total",x="años",y="Brecha de tasa de paro")
evo_brecha_total
evo_tasa_total <-  ggplot(brechas_total, aes(x = Periodo)) +geom_line(aes(y = tasa_hombres, color = "Hombres")) +geom_point(aes(y = tasa_hombres, color = "Hombres")) +geom_line(aes(y = tasa_mujeres, color = "Mujeres")) +geom_point(aes(y = tasa_mujeres, color = "Mujeres")) +labs(title = "Evolución de la tasa de paro total por sexo",x = "Año",y = "Tasa de paro (%)",color = "Sexo")
evo_tasa_total


evo_tasa_y_brecha<-ggplot(brechas_total, aes(x = Periodo)) +geom_line(aes(y = tasa_hombres, color = "Hombres"), size = 1.3) +geom_point(aes(y = tasa_hombres, color = "Hombres"), size = 2) +geom_line(aes(y = tasa_mujeres, color = "Mujeres"), size = 1.3) +geom_point(aes(y = tasa_mujeres, color = "Mujeres"), size = 2) +geom_line(aes(y = brecha_paro_total, color = "Brecha"), size = 1.2,) +geom_point(aes(y = brecha_paro_total, color = "Brecha"), size = 2) +labs(title = "Evolución de la tasa de paro total por sexo y brecha",x = "Año",y = "Tasa de paro (%)",) +scale_color_manual(values = c("Hombres" = "blue", "Mujeres" = "red", "Brecha" = "black"))+theme_minimal()
evo_tasa_y_brecha
```
El primer gráfico (`evo_brecha_total`) representa la evolución de la brecha de paro total tanto con lineas como con puntos para mostrar la tendencia y los valores anuales. En él se observa cómo la diferencia entre hombres y mujeres en la tasa de paro varía a lo largo del tiempo, con un aumento notable en los años posteriores a la crisis de 2008 y una ligera reducción en la última etapa analizada. Por su parte, el segundo gráfico (`evo_tasa_total`) muestra la evolución de la tasa de paro de hombres y mujeres de forma independiente, utilizando colores diferenciados para cada grupo. Esta visualización permite comparar directamente la evolución de ambos sexos, destacando la persistencia de una mayor tasa de paro entre las mujeres en prácticamente todos los años del periodo estudiado.

Por último, el tercer gráfico (`evo_tasa_y_brecha`) combina ambas perspectivas en una única figura. Se incluyen las líneas de hombres, mujeres y brecha, diferenciadas mediante colores específicos definidos con `scale_color_manual()`. Este enfoque conjunto facilita observar la relación entre las dos tasas y su diferencia a lo largo del tiempo, ofreciendo una visión global de la evolución de las desigualdades de género en el desempleo. En conjunto, el código y las representaciones resultantes permiten analizar de forma visual y comparativa la magnitud y la persistencia de la brecha de género en el mercado laboral español.

## Evolucion de la tasa de paro y su brecha por grupo de edad
En este bloque de código se elaboran una serie de gráficos exploratorios con el objetivo de analizar la evolución de la brecha de paro entre mujeres y hombres desagregada por grupos de edad. A partir del conjunto de datos principal, se construye una tabla denominada brecha_edades que contiene la tasa de paro por sexo y edad, y se calcula la variable brecha_paro como la diferencia entre las tasas de mujeres y hombres. Posteriormente, los grupos de edad se clasifican en intervalos de diez años, y los datos se dividen en distintos subconjuntos (df_1, df_2, df_3) para facilitar la representación y mejorar la legibilidad de los gráficos.


```{r}
brecha_edades <- datos %>% 
  select(Sexo, Edad, Periodo,Tasa_paro) %>% 
  pivot_wider(names_from = Sexo, values_from = Tasa_paro) %>% 
  mutate(brecha_paro=Mujeres-Hombres)
brecha_edades

unique(brecha_edades$Edad)
library(ggplot2)
#Para hacerlo con un unico dataframe, es muy complejo de graficar, asi que es mejor dividirlo en varios dataframes, para que así sea mas sencillo trabajar
edades_1 <- c("De 16 a 19 años", "De 20 a 24 años", "De 25 a 29 años", "De 30 a 34 años")
edades_2 <- c("De 35 a 39 años", "De 40 a 44 años", "De 45 a 49 años", "De 50 a 54 años")
edades_3 <- c("De 55 a 59 años", "De 60 a 64 años", "De 65 a 69 años", "De 70 y más años")

df_1 <- brecha_edades %>% filter(Edad %in% edades_1)
df_2 <- brecha_edades %>% filter(Edad %in% edades_2)
df_3 <- brecha_edades %>%  filter(Edad %in% edades_3)

ggplot(df_1, aes(x = Periodo, y = brecha_paro)) +
  geom_line( size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~ Edad, ncol = 2) +  # ← cuadrícula 2×2
  labs(title = "Evolución de la brecha de paro (Mujeres - Hombres)",x = "Año",y = "Brecha") +
  theme_minimal()

ggplot(df_2, aes(x = Periodo, y = brecha_paro)) +
  geom_line( size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~ Edad, ncol = 2) +  
  labs(title = "Evolución de la brecha de paro (Mujeres - Hombres)",x = "Año",y = "Brecha") +
  theme_minimal()

ggplot(df_3, aes(x = Periodo, y = brecha_paro)) +
  geom_line( size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~ Edad, ncol = 2) +  
  labs(title = "Evolución de la brecha de paro (Mujeres - Hombres)",x = "Año",y = "Brecha") +
  theme_minimal()

colores_vivos <- c(
  "#FF4B00", "#00FFFF", "#FFD300", "#FF1493",
  "#00FF00", "#1E90FF", "#FF7F50", "#ADFF2F",
  "#DA70D6", "#FF4500", "#00CED1", "#FFFF66"
)
ggplot(brecha_edades, aes(x = Periodo, y = brecha_paro,colour = Edad)) +
  geom_line( size = 0.5) +
  geom_point()  +
  labs(title = "Evolución de la brecha de paro (Mujeres - Hombres)",x = "Año",y = "Brecha") +
  theme_minimal()
```
Los primeros gráficos utilizan facet_wrap() para mostrar la evolución temporal de la brecha de paro dentro de cada grupo de edad. Cada panel representa un intervalo etario y permite observar cómo la diferencia entre hombres y mujeres ha variado a lo largo del tiempo. Estas visualizaciones, evidencian que la brecha no se comporta de manera homogénea entre generaciones: mientras que en los grupos más jóvenes las diferencias tienden a fluctuar con mayor intensidad, en los grupos intermedios y de mayor edad la brecha presenta una evolución más estable, aunque persiste una desigualdad estructural en la mayoría de los casos.

Por último, se incluye una representación global en la que se superponen todas las series de edad en un mismo gráfico, utilizando una paleta de colores vivos definida manualmente. Este gráfico tiene un carácter eminentemente exploratorio y permite comparar visualmente la magnitud y la variabilidad de la brecha de paro entre cohortes. En conjunto, este bloque de código contribuye a profundizar en el análisis intergeneracional de la desigualdad laboral, revelando que las diferencias por género en el desempleo no afectan por igual a todos los grupos de edad y que ciertos tramos, especialmente los más jóvenes, muestran una mayor volatilidad a lo largo del tiempo.

## Gráfica de Barras comparación grupos de edades con mayor brecha en 2006 y en 2024

En este bloque de código se elaboran una serie de gráficos exploratorios de barras destinados a analizar la evolución de la brecha de paro por grupos de edad a lo largo del tiempo. Para ello, a partir del conjunto brecha_edades, que contiene la diferencia entre las tasas de paro femeninas y masculinas, se genera un conjunto de gráficos individuales por año mediante la función lapply(). En cada uno de ellos, las barras representan la magnitud de la brecha en los distintos grupos de edad, mientras que la línea discontinua negra indica la media general de la brecha para ese año. De esta forma, el código permite observar en paralelo la estructura intergeneracional de las desigualdades laborales y cómo varía la media de brecha entre periodos.

```{r}

a1<- brecha_edades %>% filter(Periodo %in% 2024)

library(ggplot2)
library(dplyr)

rango_y <- range(brecha_edades$brecha_paro)
años<- unique(datos$Periodo)


grafico_brecha_paro_por_año<-lapply(años, function(año){
  brecha_edades %>% 
    filter(Periodo==año) %>% 
    ggplot( aes(x = factor(Edad, levels = unique(Edad)), y = brecha_paro)) +
  geom_col(fill = "steelblue") +
 ylim(rango_y) +
  labs(title = paste("Brecha de paro por grupo de edad -", año),x = "Grupo de edad",y = "Brecha ") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,hjust = 1) )+
    geom_hline(yintercept = mean(brecha_edades$brecha_paro[brecha_edades$Periodo == año]),
               color = "grey10", linetype = "dashed", linewidth = 1) 
})

grafico_brecha_paro_por_año

```
Los gráficos resultantes muestran, de forma clara y comparativa, cómo la intensidad de la brecha de género en el desempleo varía según la edad y el momento temporal. En los primeros años analizados, la brecha es especialmente elevada entre los jóvenes, lo que evidencia una mayor vulnerabilidad del empleo femenino en los primeros tramos de edad. En cambio, en los años más recientes para esos tramos de edad, las diferencias tienden a moderarse y presentan un patrón más equilibrado entre grupos, aunque persisten desigualdades estructurales en los segmentos intermedios y de mayor edad.

En conjunto, este bloque  busca ofrecer una visión desagregada y evolutiva de la brecha de paro por edad. Gracias a la representación mediante diagramas de barras, se facilita la comparación entre grupos generacionales y se identifican con claridad los grupos que más contribuyen a mantener las disparidades laborales entre hombres y mujeres a lo largo del tiempo.


En el siguiente bloque de código se genera una animación que muestra la evolución de la brecha de paro por grupo de edad a lo largo del tiempo, mediante transition_states() y ease_aes(), se define la animación temporal por años, que se renderiza y guarda como un archivo GIF utilizando las funciones animate() y anim_save().
```{r}
library(ggplot2)
library(gganimate)
library(dplyr)
library(gifski)

# Media por año
medias_anio <- brecha_edades %>%
  group_by(Periodo) %>%
  summarise(media = mean(brecha_paro, na.rm = TRUE))

# Gráfico
grafico_animado <- ggplot(brecha_edades,
                          aes(x = factor(Edad, levels = unique(Edad)),
                              y = brecha_paro)) +
  geom_col(aes(fill = "Brecha de paro")) +   
  geom_hline(data = medias_anio,
             aes(yintercept = media, color = "Media anual"),   
             linetype = "dashed", linewidth = 1) +
  scale_fill_manual(name="Relleno", values = c("Brecha de paro" = "steelblue")) +
  scale_color_manual( name="Linea",values = c("Media anual" = "black")) +
  labs(
    title = "Brecha de paro por grupo de edad — Año: {closest_state}",
    x = "Grupo de edad",
    y = "Brecha"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(face = "bold"),
        legend.position = "top") +
  transition_states(Periodo, transition_length = 2, state_length = 1) +
  ease_aes("linear")

# Animar
animacion <- animate(
  grafico_animado,
  nframes = length(unique(brecha_edades$Periodo)) * 10,
  fps = 10,
  renderer = gifski_renderer(),
  width = 800,
  height = 600
)

anim_save("brecha_paro.gif", animation = animacion)


browseURL("brecha_paro.gif")
```



```{r}
head(datos)


datos_composicion_2024<- datos %>% 
  filter(Periodo==2024) %>% 
  select(Periodo,Edad,Sexo,Activos,Ocupados,Parados,Inactivos) %>% 
  pivot_longer(cols = c(Inactivos,Ocupados,Parados),names_to = "Estado",values_to = "N_Personas")
  
datos_composicion_2024 %>%
  ggplot(aes(x = Edad, y = N_Personas, fill = Estado)) +
  geom_col(position = "fill") +
  labs(
    title = "Composición del mercado laboral por grupo de edad en 2024",
    x = "Grupo de edad",
    y = "Proporción",
    fill = "Estado"
  ) +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap(~Sexo)


head(mtcars)
```


```{r}

datos_composicion<- datos  %>% 
  select(Periodo,Edad,Sexo,Activos,Ocupados,Parados,Inactivos) %>% 
  pivot_longer(cols = c(Inactivos,Ocupados,Parados),names_to = "Estado",values_to = "N_Personas")

años<- unique(datos_composicion$Periodo)

graficos_composicion_por_año <- lapply(años, function(año) {
  datos_composicion %>%
    filter(Periodo == año) %>%
    ggplot(aes(x =factor(Edad, levels = unique(Edad)), y = N_Personas, fill = Estado)) +
    geom_col(position = "fill") +
    labs(
      title = paste("Composición del mercado laboral por grupo de edad -", año),
      x = "Grupo de edad",
      y = "Proporción",
      fill = "Estado"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    facet_wrap(~Sexo)#Añadir o quitar según queramos comparar hombres y mujeres o no 
})
#Hola

graficos_composicion_por_año

```

```{r}
library(gifski)
graph1 <- ggplot(datos_composicion, 
                 aes(x = factor(Edad, levels = unique(Edad)),
                     y = N_Personas, fill = Estado)) +
  geom_col(position = "fill") +
  facet_wrap(~Sexo) +
  labs(
    title = "Composición del mercado laboral por grupo de edad - Año: {frame_time}",
    x = "Grupo de edad",
    y = "Proporción",
    fill = "Estado"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  transition_time(Periodo) +
  ease_aes('linear')



# 1️⃣ Crear la animación desde el gráfico
animacion <- animate(graph1, nframes = 100, fps = 10, renderer = gifski_renderer())

# 2️⃣ Guardarla
anim_save("composicion_mercado.gif", animation = animacion)

```


La siguiente gráfica muestra del total de parados por sexo que proporcion de esos parados se encuentran en cada grupo de edad
```{r}
graficos_parados_proporcion_por_año<- lapply(años, function(año){
datos %>%
  filter(Periodo==año) %>% 
  group_by(Sexo, Periodo) %>%
  mutate(Proporcion_parados_en_sexo = Parados / sum(Parados)) %>%
  ungroup() %>%
  ggplot(aes(x = factor(Edad, levels = unique(Edad)), y = Proporcion_parados_en_sexo, fill = Sexo)) +
  geom_col(position = "dodge") +
  labs(
    title = paste("Distribución del paro dentro de cada sexo -",año),
    x = "Grupo de edad",
    y = "Proporción del total de parados del mismo sexo",
    fill = "Sexo"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
})

graficos_parados_proporcion_por_año

```





