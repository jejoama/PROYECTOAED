---
title: "GraficasProyecto"
output: html_document
date: "2025-10-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
   
# Documento para la elaboración de gráficas


##### LIMPIEZA AGAIN = copypaste de Javi

```{r}
# Ver el tipo de codificación del archivo
library(dplyr)
library(dplyr)
archivo<-"data/65948.csv"
guess_encoding(archivo)
```
# Limpieza basica
```{r}
#Limpieza de nombres de columnas
library(readr)
datos <- read_delim("data/65948.csv", delim = "\t")
library(janitor)
datos <- datos %>% clean_names()
datos
```




# Limpieza avanzada y transformación de los datos

```{r}
df <-  read_delim(archivo, delim = "\t", escape_double = FALSE, na = "..", trim_ws = TRUE,locale = locale(decimal_mark = ","))
```


```{r}
str(df)
```

```{r}
# Limpiar el dataframe usando tidyverse
df_limpio<-df %>% rename(Situacion_Laboral = `Relación con la actividad económica`) %>% mutate(Sexo=as.factor(Sexo), Edad=as.factor(Edad), Situacion_Laboral=as.factor(Situacion_Laboral))
```

```{r}
# Guardar los valores NA por si los necesitamos
df_na<-df[which(is.na(df$Total)),]
```

```{r}
df_tidy <- df_limpio %>%
  # Creamos nuevas columnas a partir de los valores de 'Situacion_Laboral'
  pivot_wider(
    names_from = Situacion_Laboral, # Los nombres de las nuevas columnas vienen de aquí
    values_from = Total            # Los valores de las nuevas columnas vienen de aquí
  ) %>% mutate(across(.cols=all_of(c("Parados","Parados que buscan primer empleo")),.fns=~replace_na(.,0))) %>% rename(Parados_sin_exp = `Parados que buscan primer empleo`)
```


```{r}
levels_sexo<-levels(df_limpio$Sexo)
levels_edad<-levels(df_limpio$Edad)
```


```{r}
sapply(df_tidy,function(x) sum(is.na(x)))
```
```{r}
# Hay algun NA?
datos %>% filter(if_any(everything(), is.na))
```


```{r}
summary(datos)
```


```{r}
df_tidy$Tasa_paro<-df_tidy$Parados/df_tidy$Activos*100
df_tidy$Tasa_actividad<-df_tidy$Activos/df_tidy$Total*100
df_tidy$Tasa_ocupacion<-df_tidy$Ocupados/df_tidy$Total*100
```










# Graficas = Joe

Agrupacaión de los datos según su año y su situación laboral
```{r}
df_agrupado <- df_limpio %>% group_by(Periodo, Situacion_Laboral) %>% summarise(total = sum(Total, na.rm = TRUE)) %>% ungroup()
df_agrupado
```

Gráfica

```{r}
library(ggplot2)
ggplot(df_agrupado, aes(x= Periodo, y=total, colour= Situacion_Laboral)) + geom_line(size=1.35) + scale_x_continuous(breaks = seq(2006, 2024, by = 2)) + scale_y_continuous(labels = scales::comma) + labs(title= "Evolución  de ocupados, parados e inactivos (2006–2024)", x= "Año", y="Personas", colour="Situación laboral" ) + theme_minimal()
```
```{r}
cat("En la gráfica se observan diversas fluctuaños en los años 2008 (debido a la crisis financiera) y 2020 (provocada por el Covid-19) tales como el aumento de Parados y disminución de los ocupados\n")
```

Ahora bien, vista la gráfica y un poco sus tendencia, seria interesante verlo desde una perspectiva de sexo y edad.
```{r}
# Agrupamos por año, sexo y edad
df_por_sexo_edad <- df_tidy %>%
  group_by(Periodo, Sexo, Edad) %>%
  summarise(
    tasa_paro = mean(Tasa_paro, na.rm = TRUE),
    tasa_actividad = mean(Tasa_actividad, na.rm = TRUE),
    tasa_ocupacion = mean(Tasa_ocupacion, na.rm = TRUE)
  ) %>% ungroup()
```


Gráfica según sexo
```{r}
library(ggplot2)

ggplot(df_por_sexo_edad, aes(x = Periodo, y = tasa_actividad, color = Edad)) +
  geom_line(size = 1) +
  facet_wrap(~Sexo) +  # Separa el gráfico por paneles según sexo
  scale_x_continuous(breaks = seq(2006, 2024, by = 2)) +  
  scale_y_continuous(labels = scales::comma) +  
  labs(
    title = "Tasa de actividad por edad y sexo (2006–2024)",
    x = "Año",
    y = "Tasa de actividad (%)",
    color = "Edad"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Inclina los años
    legend.position = "bottom"  # Mueve la leyenda abajo
  )


```

```{r}
df_por_sexo <- df_tidy %>%
  group_by(Periodo, Sexo) %>%
  summarise(Activos = sum(Activos, na.rm = TRUE), .groups = "drop")

ggplot(df_por_sexo, aes(x = Periodo, y = Activos, fill = Sexo)) +
  geom_area(alpha = 0.6) +
  labs(title = "Evolución acumulada de activos por sexo",
       x = "Año", y = "Personas", fill = "Sexo") +
  theme_minimal()
```





¿Hay diferencias entre hombres y mujeres en cada situación laboral?
```{r}
df_diferencias <- df_limpio %>%
  filter(Sexo %in% c("Hombres", "Mujeres")) %>%  # Hacemos un filtro segun si es Hombre o es Mujer, por tanto la catgoria de Ambos sexos se excluye, con la finalidad de causar duplicados
  group_by(Periodo, Sexo, Situacion_Laboral) %>%
  summarise(Personas = sum( Total, na.rm = TRUE), .groups = "drop") #hace la suma total e personas 

```

Gráfico de la diferencia 
```{r}
library(ggplot2)

ggplot(df_diferencias, aes(x = Periodo, y = Personas, color = Sexo)) +
  geom_line(size = 1.2) +
  facet_wrap(~Situacion_Laboral, scales = "free_y") +  # Panel por situación laboral
  scale_x_continuous(breaks = seq(2006, 2024, by = 2)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Diferencias entre hombres y mujeres por situación laboral (2006–2024)",
    x = "Año",
    y = "Personas",
    color = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )

```


```{r}
cat("El conjunto de gráficas nos refleja dinamicas del mercado economjco español. Por un lado, la gráfica de Ocupado muestra una mayor proporcion de hombres que de mujeres, cosa que va ligada a que los hombres siempre han tenido mayor participicaion en muchos mas sectores, como lo puede ser la construcción, y a que las mujeres se ligan mas al cuidado familiar. Por el otro, en la gráfica Inactivos la proporcion se invierte. Las mujeres son las que tienen mas tendencia al desempleo, reafimando la desifgualdad en el mercado laboral.

Algo a destacar, también, se encuentra en la gráfica Parados. Esta última va muy ligado a los ciclos economicos de nuestro país, siendo 2008 y 2020 picos donde el desempleo aumento en bastante propociones, dado que por ejemplo la crisis del 2008 al afectar a la construcción destruyó un sector donde se concentraban muchos hombres, o en 2020 con el Covid-19 estando muy afectado, por ejmeplo, la hosteleria donde encontramos mas propocion hombres-mujeres\n")
```


¿En qué edades se acentúan las diferencias entre hombres y mujeres en cada situación laboral?
```{r}
df_diferencias_edad <- df_limpio %>%
  filter(Sexo %in% c("Hombres", "Mujeres")) %>%  # Hacemos un filtro segun si es Hombre o es Mujer, por tanto la catgoria de Ambos sexos se excluye, con la finalidad de causar duplicados
  group_by(Edad, Sexo, Situacion_Laboral) %>%
  summarise(Personas = sum( Total, na.rm = TRUE), .groups = "drop") #hace la suma total e personas 

```

Gráfica
```{r}
df_porcentajes <- df_diferencias_edad %>%
  group_by(Edad, Situacion_Laboral) %>%
  mutate(Porcentaje = Personas / sum(Personas) * 100) %>%
  ungroup()

```

```{r}
library(ggplot2)

ggplot(df_porcentajes, aes(x = Edad, y = Porcentaje, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Situacion_Laboral, scales = "free_y") +
  labs(
    title = "Porcentaje por edad y sexo en cada situación laboral",
    x = "Edad",
    y = "Porcentaje (%)",
    fill = "Sexo"
  ) +
  scale_fill_brewer(palette = "Set1") +  # Colores más contrastados
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing = unit(1, "lines"),
    legend.position = "bottom"
  )


```


```{r}
library(ggplot2)

ggplot(df_porcentajes, aes(x = Edad, y = Porcentaje, color = Sexo)) +
  geom_point(size = 3, alpha = 0.8) +
  facet_wrap(~Situacion_Laboral, scales = "free_y") +
  labs(
    title = "Comparación por edad y sexo en cada situación laboral",
    x = "Edad",
    y = "Porcentaje (%)",
    color = "Sexo"
  ) +
  scale_color_brewer(palette = "Set1") +  # Colores contrastados
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )


```


```{r}
ggplot(df_porcentajes, aes(x = Sexo, y = Porcentaje, fill = Sexo)) +
  geom_boxplot() +
  facet_wrap(~Situacion_Laboral, scales = "free_y") +
  labs(title = "Distribución de porcentajes por sexo en cada situación laboral",
       x = "Sexo", y = "Porcentaje (%)") +
  theme_minimal()


```



¿Qué grupos de edad tienen más ocupados o parados?
```{r}
df_ocupados_parados <- df_limpio %>%
  filter(Situacion_Laboral %in% c("Ocupados", "Parados")) %>%
  group_by(Edad, Situacion_Laboral) %>%
  summarise(Personas = sum(Total, na.rm = TRUE), .groups = "drop")

```


Gráfica
```{r}
library(ggplot2)

ggplot(df_ocupados_parados, aes(x = Edad, y = Personas, fill = Situacion_Laboral)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Distribución de ocupados y parados por grupo de edad",
    x = "Edad",
    y = "Personas",
    fill = "Situación laboral"
  ) +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```





CRISIS GRAFICA
```{r}
df_barras_crisis <- df_limpio %>%
  filter(Situacion_Laboral %in% c("Ocupados", "Parados")) %>%
  group_by(Periodo, Situacion_Laboral) %>%
  summarise(Personas = sum(Total, na.rm = TRUE), .groups = "drop")

library(ggplot2)

ggplot(df_barras_crisis, aes(x = Periodo, y = Personas, fill = Situacion_Laboral)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_continuous(breaks = seq(2006, 2024, by = 2)) +  # años cada 2
  labs(
    title = "Evolución de ocupados y parados en España (2006–2024)",
    x = "Año",
    y = "Personas",
    fill = "Situación laboral"
  ) +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )





```






